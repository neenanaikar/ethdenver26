generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Agent: An AI agent registered on the platform
model Agent {
  id              String   @id @default(uuid())
  name            String
  description     String?
  apiKey          String   @unique

  // On-chain identity (ERC-7857 iNFT on 0G Chain)
  inftTokenId     String?  @unique

  // Claim flow (builder claims ownership later)
  claimCode       String?  @unique  // Secret code for claiming (arena_claim_xxx)
  claimCodeHash   String?           // Keccak256 hash for on-chain verification
  claimed         Boolean  @default(false)
  claimedAt       DateTime?
  claimedBy       String?           // Builder's wallet address after claiming

  // Stats
  wins            Int      @default(0)
  losses          Int      @default(0)
  draws           Int      @default(0)
  eloRating       Int      @default(1200)
  bestClickCount  Int?

  createdAt       DateTime @default(now())

  // Relations
  matchesAsAgent1 Match[]  @relation("Agent1")
  matchesAsAgent2 Match[]  @relation("Agent2")
  matchesWon      Match[]  @relation("Winner")
  queueEntry      QueueEntry?
}

// QueueEntry: An agent waiting in the matchmaking queue
model QueueEntry {
  id        String   @id @default(uuid())
  agentId   String   @unique // One queue entry per agent
  agent     Agent    @relation(fields: [agentId], references: [id])
  createdAt DateTime @default(now())
}

// Match: A 1v1 Wikipedia Speedrun competition
model Match {
  id              String   @id @default(uuid())

  // Status: waiting_for_opponent | ready_check | active | complete | cancelled
  status          String   @default("waiting_for_opponent")

  // Competition details
  startArticle    String   // e.g., "/wiki/Capybara"
  targetArticle   String   // e.g., "Philosophy"
  timeLimitSeconds Int     @default(300)

  // Participants (1v1)
  agent1Id        String?
  agent1          Agent?   @relation("Agent1", fields: [agent1Id], references: [id])
  agent2Id        String?
  agent2          Agent?   @relation("Agent2", fields: [agent2Id], references: [id])

  // Ready status (both must be ready before match starts)
  agent1Ready     Boolean  @default(false)
  agent2Ready     Boolean  @default(false)

  // Tracking paths (JSON arrays of article titles)
  agent1Path      String   @default("[]")  // JSON: ["Capybara", "Rodent", "Mammal"]
  agent2Path      String   @default("[]")  // JSON
  agent1Clicks    Int      @default(0)
  agent2Clicks    Int      @default(0)
  agent1LastUrl   String?
  agent2LastUrl   String?

  // Result
  winnerId        String?
  winner          Agent?   @relation("Winner", fields: [winnerId], references: [id])

  // Timing
  startedAt       DateTime?
  endsAt          DateTime?
  completedAt     DateTime?

  createdAt       DateTime @default(now())
}
